{% extends "base.html" %}

{% block title %}Importar Transações - {{ super() }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-upload"></i> Importar Transações via CSV
                </h4>
            </div>
            <div class="card-body">
                <!-- Instruções -->
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Como importar suas transações:</h6>
                    <ol class="mb-0">
                        <li>Baixe o modelo CSV ou prepare seu arquivo seguindo o formato</li>
                        <li>Preencha os dados das suas transações</li>
                        <li>Faça upload do arquivo preenchido</li>
                    </ol>
                </div>

                <!-- Modelo CSV -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="bi bi-file-earmark-spreadsheet display-4 text-primary"></i>
                                <h6 class="mt-2">Baixar Modelo</h6>
                                <p class="text-muted small">Arquivo CSV com formato correto</p>
                                <a href="#" class="btn btn-outline-primary btn-sm" onclick="downloadTemplate()">
                                    <i class="bi bi-download"></i> Baixar modelo.csv
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-list-check"></i> Formato esperado:</h6>
                                <table class="table table-sm small">
                                    <thead>
                                        <tr>
                                            <th>Campo</th>
                                            <th>Exemplo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>data</td><td>01/12/2024</td></tr>
                                        <tr><td>tipo</td><td>receita / despesa</td></tr>
                                        <tr><td>valor</td><td>150.50</td></tr>
                                        <tr><td>categoria</td><td>Alimentação</td></tr>
                                        <tr><td>descricao</td><td>Supermercado</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Upload -->
                <form method="POST" enctype="multipart/form-data" id="importForm">
                    <div class="mb-3">
                        <label for="file" class="form-label">Arquivo CSV *</label>
                        <input type="file" class="form-control" id="file" name="file" 
                               accept=".csv" required>
                        <div class="form-text">Apenas arquivos .csv são aceitos (máximo 5MB)</div>
                    </div>

                    <!-- Conta (se tiver famílias) -->
                    {% if user.families %}
                    <div class="mb-3">
                        <label for="account_type" class="form-label">Importar para</label>
                        <select class="form-select" id="account_type" name="account_type">
                            <option value="individual">Minha Conta Individual</option>
                            <option value="family">Conta da Família</option>
                        </select>
                    </div>
                    {% endif %}

                    <!-- Prévia do arquivo -->
                    <div id="filePreview" class="mb-3" style="display: none;">
                        <label class="form-label">Prévia do arquivo:</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="previewContent"></div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard.transactions') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success" id="importBtn">
                            <i class="bi bi-upload"></i> Importar Transações
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dicas de Importação -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Dicas para Importação</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>✅ Formato de Data</h6>
                        <ul class="small text-muted">
                            <li>dd/mm/aaaa (01/12/2024)</li>
                            <li>aaaa-mm-dd (2024-12-01)</li>
                            <li>dd-mm-aaaa (01-12-2024)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>✅ Tipos Aceitos</h6>
                        <ul class="small text-muted">
                            <li><strong>Receitas:</strong> receita, income</li>
                            <li><strong>Despesas:</strong> despesa, expense</li>
                        </ul>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>✅ Valores Numéricos</h6>
                        <ul class="small text-muted">
                            <li>Use ponto para decimais: 150.50</li>
                            <li>Não use símbolos de moeda</li>
                            <li>Valores sempre positivos</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>⚠️ Atenção</h6>
                        <ul class="small text-muted">
                            <li>Categorias são obrigatórias</li>
                            <li>Transações duplicadas serão importadas</li>
                            <li>Verifique os dados antes de importar</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Preview do arquivo
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type === 'text/csv') {
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            const lines = csv.split('\n').slice(0, 6); // Primeiras 5 linhas + cabeçalho
            
            let preview = '<small class="text-muted">Primeiras linhas do arquivo:</small><br>';
            preview += '<pre class="small">' + lines.join('\n') + '</pre>';
            
            document.getElementById('previewContent').innerHTML = preview;
            document.getElementById('filePreview').style.display = 'block';
        };
        reader.readAsText(file);
    }
});

// Download do template
function downloadTemplate() {
    const csvContent = `data,tipo,valor,categoria,descricao
01/12/2024,receita,3500.00,Salário,Salário mensal
02/12/2024,despesa,45.80,Alimentação,Supermercado
03/12/2024,despesa,12.50,Transporte,Passagem de ônibus
04/12/2024,receita,200.00,Freelance,Trabalho extra
05/12/2024,despesa,85.00,Lazer,Cinema e pipoca`;

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'modelo_transacoes.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Validação do formulário
document.getElementById('importForm').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('file');
    const file = fileInput.files[0];
    
    if (!file) {
        e.preventDefault();
        alert('Por favor, selecione um arquivo CSV');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        e.preventDefault();
        alert('Apenas arquivos CSV são aceitos');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) { // 5MB
        e.preventDefault();
        alert('Arquivo muito grande. Máximo 5MB permitido');
        return;
    }
    
    // Mostrar loading
    const submitBtn = document.getElementById('importBtn');
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importando...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}