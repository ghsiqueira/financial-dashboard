{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    .quick-action-btn {
        height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-5px);
        text-decoration: none;
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .quick-action-btn i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .account-switcher {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .account-switcher .btn-group .btn {
        border-radius: 0.5rem;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        margin: 0 0.25rem;
    }
    
    .account-switcher .btn-group .btn.active {
        background: white;
        color: #667eea;
        border-color: white;
    }
    
    .account-switcher .btn-group .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
    }
    
    .family-header {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .family-header h4 {
        margin-bottom: 0.5rem;
    }
    
    .family-actions-header {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .family-actions-header .btn {
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
    }
    
    .family-actions-header .btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
        .family-actions-header {
            gap: 0.5rem;
        }
        
        .family-actions-header .btn {
            font-size: 0.875rem;
            padding: 0.4rem 0.8rem;
        }
        
        .account-switcher .btn-group .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<body data-page="dashboard">

<!-- üî• NOVO: Seletor de Conta Melhorado -->
<div class="account-switcher">
    <div class="family-header">
        {% if active_account == 'family' %}
            <i class="bi bi-people display-6"></i>
            <h4>
                {% if user_families %}
                    {% for family in user_families %}
                        {% if family._id|string == active_family_id %}
                            {{ family.name }}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    Conta Familiar
                {% endif %}
            </h4>
            <p class="mb-0 opacity-75">Finan√ßas compartilhadas da fam√≠lia</p>
        {% else %}
            <i class="bi bi-person display-6"></i>
            <h4>Conta Individual</h4>
            <p class="mb-0 opacity-75">Suas finan√ßas pessoais</p>
        {% endif %}
    </div>
    
    <div class="d-flex justify-content-center">
        <div class="btn-group" role="group">
            <a href="{{ url_for('dashboard.overview', account='individual') }}" 
               class="btn {% if active_account == 'individual' %}active{% endif %}">
                <i class="bi bi-person"></i> Individual
            </a>
            {% if user_families %}
                <a href="{{ url_for('dashboard.overview', account='family') }}" 
                   class="btn {% if active_account == 'family' %}active{% endif %}">
                    <i class="bi bi-people"></i> Fam√≠lia
                </a>
            {% endif %}
        </div>
    </div>
    
    <!-- üéØ BOT√ïES DE A√á√ÉO (s√≥ para fam√≠lia) -->
    {% if active_account == 'family' and user_families %}
        <div class="family-actions-header">
            {% set family_id = user_families[0]._id if user_families else none %}
            {% if family_id %}
            <a href="{{ url_for('family.manage', family_id=family_id) }}" 
               class="btn btn-sm">
                <i class="bi bi-people"></i> Gerenciar Fam√≠lia
            </a>
            <a href="{{ url_for('family.invite', family_id=family_id) }}" 
               class="btn btn-sm">
                <i class="bi bi-person-plus"></i> Convidar Membros
            </a>
            <a href="{{ url_for('family.family_settings', family_id=family_id) }}" 
               class="btn btn-sm">
                <i class="bi bi-gear"></i> Configura√ß√µes
            </a>
            {% endif %}
        </div>
    {% elif active_account == 'individual' and not user_families %}
        <!-- Bot√µes para criar fam√≠lia quando n√£o tem nenhuma -->
        <div class="family-actions-header">
            <a href="{{ url_for('family.create_family') }}" class="btn btn-sm">
                <i class="bi bi-plus-circle"></i> Criar Fam√≠lia
            </a>
            <a href="{{ url_for('family.join') }}" class="btn btn-sm">
                <i class="bi bi-box-arrow-in-right"></i> Entrar em Fam√≠lia
            </a>
        </div>
    {% endif %}
</div>

<!-- Cards de Resumo -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card stats-card income">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="total-income">
                        {{ format_currency(monthly_summary.income) }}
                    </div>
                    <div class="stats-label">Receitas do M√™s</div>
                </div>
                <div class="stats-icon">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card stats-card expense">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="total-expense">
                        {{ format_currency(monthly_summary.expense) }}
                    </div>
                    <div class="stats-label">Despesas do M√™s</div>
                </div>
                <div class="stats-icon">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card stats-card {% if monthly_summary.balance > 0 %}income{% elif monthly_summary.balance < 0 %}expense{% else %}balance{% endif %}">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="balance">
                        {{ format_currency(monthly_summary.balance) }}
                    </div>
                    <div class="stats-label">Saldo do M√™s</div>
                </div>
                <div class="stats-icon">
                    <i class="bi bi-{% if monthly_summary.balance > 0 %}plus{% elif monthly_summary.balance < 0 %}dash{% else %}equals{% endif %}-circle"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- A√ß√µes R√°pidas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> A√ß√µes R√°pidas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('transactions.add_transaction') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                           class="quick-action-btn bg-gradient-success text-white">
                            <i class="bi bi-plus-circle"></i>
                            <span>Nova Receita</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('transactions.add_transaction') }}?type=expense{% if active_account == 'family' %}&account=family{% endif %}" 
                           class="quick-action-btn bg-gradient-danger text-white">
                            <i class="bi bi-dash-circle"></i>
                            <span>Nova Despesa</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('transactions.import_transactions') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                           class="quick-action-btn bg-gradient-primary text-white">
                            <i class="bi bi-upload"></i>
                            <span>Importar</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('dashboard.reports') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                           class="quick-action-btn bg-gradient-info text-white">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Relat√≥rios</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gr√°ficos e Transa√ß√µes -->
<div class="row">
    <!-- Gr√°ficos -->
    <div class="col-lg-8">
        <!-- Evolu√ß√£o Mensal -->
        <div class="chart-container mb-4">
            <div class="chart-title">
                <i class="bi bi-graph-up"></i> Evolu√ß√£o Financeira
                <small class="text-muted ms-2">(√öltimos 12 meses)</small>
            </div>
            <div id="chart-monthly-evolution" style="height: 400px;">
                {% if not charts_data.monthly_evolution %}
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center text-muted">
                        <i class="bi bi-graph-up display-4"></i>
                        <p class="mt-2">Dados do gr√°fico n√£o dispon√≠veis</p>
                        <small>Adicione transa√ß√µes para ver a evolu√ß√£o</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Gastos por Categoria -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-pie-chart"></i> Gastos por Categoria
                <small class="text-muted ms-2">(√öltimos 30 dias)</small>
            </div>
            <div id="chart-expenses-by-category" style="height: 400px;">
                {% if not charts_data.expenses_pie %}
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center text-muted">
                        <i class="bi bi-pie-chart display-4"></i>
                        <p class="mt-2">Nenhum gasto registrado</p>
                        <small>Adicione despesas para ver o gr√°fico</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Transa√ß√µes Recentes -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Transa√ß√µes Recentes</h6>
                <a href="{{ url_for('dashboard.transactions') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                   class="btn btn-sm btn-outline-primary">
                    Ver todas
                </a>
            </div>
            <div class="card-body p-0">
                <div id="recent-transactions">
                    {% if recent_transactions %}
                        {% for transaction in recent_transactions[:5] %}
                        <div class="transaction-item {{ transaction.type }} p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ transaction.description or 'Sem descri√ß√£o' }}</h6>
                                    <small class="text-muted">
                                        {{ transaction.category }} ‚Ä¢ {{ format_date(transaction.date) }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="transaction-amount {{ transaction.type }}">
                                        {% if transaction.type == 'income' %}+{% else %}-{% endif %}{{ format_currency(transaction.amount) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">Nenhuma transa√ß√£o encontrada</p>
                            <a href="{{ url_for('transactions.add_transaction') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                               class="btn btn-primary btn-sm">
                                Adicionar primeira transa√ß√£o
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Or√ßamentos -->
        {% if budgets %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-piggy-bank"></i> Or√ßamentos</h6>
                <a href="{{ url_for('dashboard.budgets') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                   class="btn btn-sm btn-outline-primary">
                    Gerenciar
                </a>
            </div>
            <div class="card-body">
                {% for budget in budgets[:3] %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="fw-bold">{{ budget.category }}</small>
                        <small class="text-muted">
                            {{ format_currency(budget.current_spent) }} / {{ format_currency(budget.limit) }}
                        </small>
                    </div>
                    <div class="budget-progress">
                        {% set percentage = (budget.current_spent / budget.limit * 100) if budget.limit > 0 else 0 %}
                        <div class="budget-progress-bar {% if percentage < 70 %}success{% elif percentage < 90 %}warning{% else %}danger{% endif %}" 
                             style="width: {{ [percentage, 100]|min }}%;">
                        </div>
                    </div>
                    <small class="text-muted">
                        {% if percentage < 100 %}
                            Restam {{ format_currency(budget.limit - budget.current_spent) }}
                        {% else %}
                            <span class="text-danger">Or√ßamento excedido!</span>
                        {% endif %}
                    </small>
                </div>
                {% endfor %}
                
                {% if budgets|length > 3 %}
                <div class="text-center">
                    <small class="text-muted">E mais {{ budgets|length - 3 }} or√ßamento{{ 's' if budgets|length - 3 != 1 else '' }}...</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <!-- Card para criar or√ßamentos -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-piggy-bank"></i> Or√ßamentos</h6>
            </div>
            <div class="card-body text-center">
                <i class="bi bi-piggy-bank display-4 text-muted"></i>
                <p class="mt-2 mb-3 text-muted">Nenhum or√ßamento configurado</p>
                <a href="{{ url_for('dashboard.budgets') }}{% if active_account == 'family' %}?account=family{% endif %}" 
                   class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> Criar Or√ßamento
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Estat√≠sticas da Fam√≠lia (se aplic√°vel) -->
        {% if active_account == 'family' and active_family_id %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-people"></i> Estat√≠sticas da Fam√≠lia</h6>
            </div>
            <div class="card-body">
                <div id="family-stats">
                    <div class="text-center">
                        <div class="loading"></div>
                        <small class="text-muted mt-2">Carregando estat√≠sticas...</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Dicas de Economia (se conta individual sem fam√≠lia) -->
        {% if active_account == 'individual' and not user_families %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Dica do Dia</h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <i class="bi bi-people display-4 text-info"></i>
                    <h6 class="mt-2">Experimente as Fam√≠lias!</h6>
                    <p class="small text-muted">
                        Gerencie finan√ßas compartilhadas com sua fam√≠lia. 
                        Acompanhem juntos os gastos e or√ßamentos.
                    </p>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('family.create_family') }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus-circle"></i> Criar Fam√≠lia
                        </a>
                        <a href="{{ url_for('family.join') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-box-arrow-in-right"></i> Entrar em Fam√≠lia
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Gr√°fico Comparativo (Receitas vs Despesas) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-bar-chart"></i> Receitas vs Despesas 
                <small class="text-muted ms-2">(√öltimos 6 meses)</small>
            </div>
            <div id="chart-income-vs-expenses" style="height: 300px;">
                {% if not charts_data.income_vs_expenses %}
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center text-muted">
                        <i class="bi bi-bar-chart display-4"></i>
                        <p class="mt-2">Gr√°fico n√£o dispon√≠vel</p>
                        <small>Adicione receitas e despesas para comparar</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Toast de Boas-vindas (apenas na primeira visita) -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="welcomeToast" class="toast" role="alert" data-bs-delay="5000">
        <div class="toast-header">
            <i class="bi bi-star-fill text-warning me-2"></i>
            <strong class="me-auto">Bem-vindo!</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            {% if active_account == 'family' %}
            üéâ Voc√™ est√° na conta da fam√≠lia! Use os bot√µes no header para gerenciar membros e configura√ß√µes.
            {% else %}
            üí° Dica: Crie uma fam√≠lia para compartilhar finan√ßas com seus familiares!
            {% endif %}
        </div>
    </div>
</div>

</body>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Carregar gr√°ficos
    const accountType = '{{ active_account }}';
    
    // Gr√°fico de evolu√ß√£o mensal
    {% if charts_data.monthly_evolution %}
    try {
        const monthlyData = {{ charts_data.monthly_evolution|safe }};
        Plotly.newPlot('chart-monthly-evolution', monthlyData.data, monthlyData.layout, {
            responsive: true, 
            displayModeBar: false,
            locale: 'pt-BR'
        });
    } catch (error) {
        console.error('Erro ao carregar gr√°fico mensal:', error);
    }
    {% endif %}
    
    // Gr√°fico de gastos por categoria
    {% if charts_data.expenses_pie %}
    try {
        const expensesData = {{ charts_data.expenses_pie|safe }};
        Plotly.newPlot('chart-expenses-by-category', expensesData.data, expensesData.layout, {
            responsive: true, 
            displayModeBar: false,
            locale: 'pt-BR'
        });
    } catch (error) {
        console.error('Erro ao carregar gr√°fico de categorias:', error);
    }
    {% endif %}
    
    // Gr√°fico receitas vs despesas
    {% if charts_data.income_vs_expenses %}
    try {
        const incomeExpenseData = {{ charts_data.income_vs_expenses|safe }};
        Plotly.newPlot('chart-income-vs-expenses', incomeExpenseData.data, incomeExpenseData.layout, {
            responsive: true, 
            displayModeBar: false,
            locale: 'pt-BR'
        });
    } catch (error) {
        console.error('Erro ao carregar gr√°fico comparativo:', error);
    }
    {% endif %}
    
    // Carregar estat√≠sticas da fam√≠lia
    {% if active_account == 'family' and active_family_id %}
    loadFamilyStats('{{ active_family_id }}');
    {% endif %}
    
    // Mostrar toast de boas-vindas (apenas uma vez por sess√£o)
    if (!sessionStorage.getItem('welcomeToastShown')) {
        const welcomeToast = new bootstrap.Toast(document.getElementById('welcomeToast'));
        welcomeToast.show();
        sessionStorage.setItem('welcomeToastShown', 'true');
    }
    
    // Auto-refresh a cada 5 minutos (apenas os cards de resumo)
    setInterval(function() {
        refreshSummaryCards(accountType);
    }, 300000);
});

{% if active_account == 'family' and active_family_id %}
async function loadFamilyStats(familyId) {
    try {
        const response = await fetch(`/family/api/stats/${familyId}`);
        const stats = await response.json();
        
        const html = `
            <div class="row text-center">
                <div class="col-6">
                    <div class="stat-item">
                        <div class="h4 mb-0 text-primary">${stats.member_count || 0}</div>
                        <small class="text-muted">Membros</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-item">
                        <div class="h4 mb-0 text-info">${stats.transaction_count || 0}</div>
                        <small class="text-muted">Transa√ß√µes</small>
                    </div>
                </div>
            </div>
            ${stats.top_spender ? `
                <hr>
                <div class="text-center">
                    <small class="text-muted">Maior gastador do m√™s:</small>
                    <div class="fw-bold">${stats.top_spender.name}</div>
                    <div class="text-danger">${FinanceDash.Utils.formatCurrency(stats.top_spender.amount)}</div>
                </div>
            ` : ''}
            <div class="text-center mt-3">
                <a href="{{ url_for('family.manage', family_id=active_family_id) }}" 
                   class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> Ver Detalhes
                </a>
            </div>
        `;
        
        document.getElementById('family-stats').innerHTML = html;
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas da fam√≠lia:', error);
        document.getElementById('family-stats').innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-exclamation-triangle"></i>
                <p class="mt-2 mb-0">Erro ao carregar estat√≠sticas</p>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="loadFamilyStats('${familyId}')">
                    <i class="bi bi-arrow-clockwise"></i> Tentar novamente
                </button>
            </div>
        `;
    }
}
{% endif %}

async function refreshSummaryCards(accountType) {
    try {
        const response = await fetch(`/dashboard/api/summary?account=${accountType}`);
        const data = await response.json();
        
        // Atualizar cards
        if (data.income !== undefined) {
            document.getElementById('total-income').textContent = FinanceDash.Utils.formatCurrency(data.income);
        }
        if (data.expense !== undefined) {
            document.getElementById('total-expense').textContent = FinanceDash.Utils.formatCurrency(data.expense);
        }
        if (data.balance !== undefined) {
            document.getElementById('balance').textContent = FinanceDash.Utils.formatCurrency(data.balance);
            
            // Atualizar classe do card de saldo
            const balanceCard = document.getElementById('balance').closest('.card');
            if (balanceCard) {
                balanceCard.className = balanceCard.className.replace(/stats-card\s\w+/, 'stats-card');
                if (data.balance > 0) {
                    balanceCard.classList.add('income');
                } else if (data.balance < 0) {
                    balanceCard.classList.add('expense');
                } else {
                    balanceCard.classList.add('balance');
                }
            }
        }
        
        console.log('üìä Cards de resumo atualizados');
    } catch (error) {
        console.error('Erro ao atualizar resumo:', error);
    }
}

// Fun√ß√£o para atualizar gr√°ficos manualmente
function refreshCharts() {
    window.location.reload();
}
</script>
{% endblock %}