{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    .quick-action-btn {
        height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-5px);
        text-decoration: none;
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .quick-action-btn i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<body data-page="dashboard">

<!-- Seletor de Conta -->
<div class="account-selector">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-{% if active_account == 'family' %}people{% else %}person{% endif %}"></i>
            {% if active_account == 'family' %}
                Conta Familiar
                {% if active_family_id %}
                    {% for family in user_families %}
                        {% if family._id|string == active_family_id %}
                            - {{ family.name }}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% else %}
                Conta Individual
            {% endif %}
        </h5>
        
        <div class="btn-group" role="group">
            <a href="{{ url_for('dashboard.overview', account='individual') }}" 
               class="btn btn-sm {% if active_account == 'individual' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="bi bi-person"></i> Individual
            </a>
            {% if user_families %}
                <a href="{{ url_for('dashboard.overview', account='family') }}" 
                   class="btn btn-sm {% if active_account == 'family' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    <i class="bi bi-people"></i> Família
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Cards de Resumo -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card stats-card income">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="total-income">
                        {{ format_currency(monthly_summary.income) }}
                    </div>
                    <div class="stats-label">Receitas do Mês</div>
                </div>
                <div class="stats-icon">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card stats-card expense">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="total-expense">
                        {{ format_currency(monthly_summary.expense) }}
                    </div>
                    <div class="stats-label">Despesas do Mês</div>
                </div>
                <div class="stats-icon">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card stats-card {% if monthly_summary.balance > 0 %}income{% elif monthly_summary.balance < 0 %}expense{% else %}balance{% endif %}">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="balance">
                        {{ format_currency(monthly_summary.balance) }}
                    </div>
                    <div class="stats-label">Saldo do Mês</div>
                </div>
                <div class="stats-icon">
                    <i class="bi bi-{% if monthly_summary.balance > 0 %}plus{% elif monthly_summary.balance < 0 %}dash{% else %}equals{% endif %}-circle"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('transactions.add_transaction') }}" 
                           class="quick-action-btn bg-gradient-success text-white">
                            <i class="bi bi-plus-circle"></i>
                            <span>Nova Receita</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('transactions.add_transaction') }}?type=expense" 
                           class="quick-action-btn bg-gradient-danger text-white">
                            <i class="bi bi-dash-circle"></i>
                            <span>Nova Despesa</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('transactions.import_transactions') }}" 
                           class="quick-action-btn bg-gradient-primary text-white">
                            <i class="bi bi-upload"></i>
                            <span>Importar</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <a href="{{ url_for('dashboard.reports') }}" 
                           class="quick-action-btn bg-gradient-info text-white">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Relatórios</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos e Transações -->
<div class="row">
    <!-- Gráficos -->
    <div class="col-lg-8">
        <!-- Evolução Mensal -->
        <div class="chart-container mb-4">
            <div class="chart-title">Evolução Financeira</div>
            <div id="chart-monthly-evolution" style="height: 400px;"></div>
        </div>
        
        <!-- Gastos por Categoria -->
        <div class="chart-container">
            <div class="chart-title">Gastos por Categoria</div>
            <div id="chart-expenses-by-category" style="height: 400px;"></div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Transações Recentes -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Transações Recentes</h6>
                <a href="{{ url_for('dashboard.transactions') }}" class="btn btn-sm btn-outline-primary">
                    Ver todas
                </a>
            </div>
            <div class="card-body p-0">
                <div id="recent-transactions">
                    {% if recent_transactions %}
                        {% for transaction in recent_transactions[:5] %}
                        <div class="transaction-item {{ transaction.type }} p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ transaction.description or 'Sem descrição' }}</h6>
                                    <small class="text-muted">
                                        {{ transaction.category }} • {{ format_date(transaction.date) }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="transaction-amount {{ transaction.type }}">
                                        {% if transaction.type == 'income' %}+{% else %}-{% endif %}{{ format_currency(transaction.amount) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">Nenhuma transação encontrada</p>
                            <a href="{{ url_for('transactions.add_transaction') }}" class="btn btn-primary btn-sm">
                                Adicionar primeira transação
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Orçamentos -->
        {% if budgets %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-piggy-bank"></i> Orçamentos</h6>
                <a href="{{ url_for('dashboard.budgets') }}" class="btn btn-sm btn-outline-primary">
                    Gerenciar
                </a>
            </div>
            <div class="card-body">
                {% for budget in budgets[:3] %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="fw-bold">{{ budget.category }}</small>
                        <small class="text-muted">
                            {{ format_currency(budget.current_spent) }} / {{ format_currency(budget.limit) }}
                        </small>
                    </div>
                    <div class="budget-progress">
                        {% set percentage = (budget.current_spent / budget.limit * 100) if budget.limit > 0 else 0 %}
                        <div class="budget-progress-bar {% if percentage < 70 %}success{% elif percentage < 90 %}warning{% else %}danger{% endif %}" 
                             style="width: {{ [percentage, 100]|min }}%;">
                        </div>
                    </div>
                    <small class="text-muted">
                        {% if percentage < 100 %}
                            Restam {{ format_currency(budget.limit - budget.current_spent) }}
                        {% else %}
                            <span class="text-danger">Orçamento excedido!</span>
                        {% endif %}
                    </small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Estatísticas da Família (se aplicável) -->
        {% if active_account == 'family' and active_family_id %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-people"></i> Estatísticas da Família</h6>
            </div>
            <div class="card-body">
                <div id="family-stats">
                    <div class="text-center">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Gráfico Comparativo (Receitas vs Despesas) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="chart-title">Receitas vs Despesas (Últimos 6 meses)</div>
            <div id="chart-income-vs-expenses" style="height: 300px;"></div>
        </div>
    </div>
</div>

</body>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Carregar gráficos
    const accountType = '{{ active_account }}';
    
    // Gráfico de evolução mensal
    {% if charts_data.monthly_evolution %}
    const monthlyData = {{ charts_data.monthly_evolution|safe }};
    Plotly.newPlot('chart-monthly-evolution', monthlyData.data, monthlyData.layout, {responsive: true, displayModeBar: false});
    {% endif %}
    
    // Gráfico de gastos por categoria
    {% if charts_data.expenses_pie %}
    const expensesData = {{ charts_data.expenses_pie|safe }};
    Plotly.newPlot('chart-expenses-by-category', expensesData.data, expensesData.layout, {responsive: true, displayModeBar: false});
    {% endif %}
    
    // Gráfico receitas vs despesas
    {% if charts_data.income_vs_expenses %}
    const incomeExpenseData = {{ charts_data.income_vs_expenses|safe }};
    Plotly.newPlot('chart-income-vs-expenses', incomeExpenseData.data, incomeExpenseData.layout, {responsive: true, displayModeBar: false});
    {% endif %}
    
    // Carregar estatísticas da família
    {% if active_account == 'family' and active_family_id %}
    loadFamilyStats('{{ active_family_id }}');
    {% endif %}
    
    // Auto-refresh a cada 5 minutos
    setInterval(function() {
        FinanceDash.Dashboard.loadData(accountType);
    }, 300000);
});

{% if active_account == 'family' and active_family_id %}
async function loadFamilyStats(familyId) {
    try {
        const stats = await FinanceDash.API.get(`/family/api/stats/${familyId}`);
        
        const html = `
            <div class="row text-center">
                <div class="col-6">
                    <div class="stat-item">
                        <div class="h4 mb-0 text-primary">${stats.member_count}</div>
                        <small class="text-muted">Membros</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-item">
                        <div class="h4 mb-0 text-info">${stats.transaction_count}</div>
                        <small class="text-muted">Transações</small>
                    </div>
                </div>
            </div>
            ${stats.top_spender ? `
                <hr>
                <div class="text-center">
                    <small class="text-muted">Maior gastador do mês:</small>
                    <div class="fw-bold">${stats.top_spender.name}</div>
                    <div class="text-danger">${FinanceDash.Utils.formatCurrency(stats.top_spender.amount)}</div>
                </div>
            ` : ''}
        `;
        
        document.getElementById('family-stats').innerHTML = html;
    } catch (error) {
        document.getElementById('family-stats').innerHTML = '<p class="text-muted text-center">Erro ao carregar estatísticas</p>';
    }
}
{% endif %}
</script>
{% endblock %}